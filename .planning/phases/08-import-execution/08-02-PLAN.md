---
phase: 08-import-execution
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-auto-applier.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php
autonomous: true
---

<objective>
Add task status synchronization and overwrite protection to complete the import requirements.

Purpose: Ensure club_id_map_tasks reflects import progress and existing data is never overwritten without confirmation.
Output: Task status updates on apply, overwrite check before update.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-import-execution/08-01-SUMMARY.md

# Source files to modify
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-auto-applier.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/query-club-queue.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add task status update to FFM_Auto_Applier::apply_match()</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-auto-applier.php</files>
  <action>
Modify update_provider_ids() method to also update club_id_map_tasks:

After updating provider ID columns in clubs table, add a loop that updates club_id_map_tasks for each provider that was updated:

```php
// After successful clubs table update, update task statuses
$source_code_map = [
    'w_id'    => 'whoscored',
    't_id'    => 'transfermarkt',
    'sf_id'   => 'sofifa',
    'o_id'    => 'opta',
    'fmob_id' => 'fotmob',
    'sm_id'   => 'sportmonks',
    'is_id'   => 'instat',
    'sc_id'   => 'skillcorner',
    'fmgr_id' => 'footballmanager',
];

foreach ($provider_ids as $db_column => $value) {
    if (isset($source_code_map[$db_column])) {
        $source_code = $source_code_map[$db_column];
        $this->db->query(
            $this->db->prepare(
                "UPDATE club_id_map_tasks SET status = 'done' WHERE club_id = %d AND source_code = %s",
                $club_id,
                $source_code
            )
        );
    }
}
```

This fulfills UPDATE-03: Update club_id_map_tasks status to 'done' after successful import.
  </action>
  <verify>grep -n "club_id_map_tasks" class-ffm-auto-applier.php shows UPDATE query</verify>
  <done>Auto-applier updates task status to 'done' for each provider ID applied</done>
</task>

<task type="auto">
  <name>Task 2: Add overwrite protection to FFM_Auto_Applier::update_provider_ids()</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-auto-applier.php</files>
  <action>
Modify update_provider_ids() to skip columns that already have values in the database:

1. Before building the UPDATE query, fetch current values:
```php
// Fetch current provider ID values for this club
$existing = $this->db->get_row(
    $this->db->prepare(
        "SELECT w_id, t_id, sf_id, o_id, fmob_id, sm_id, is_id, sc_id, fmgr_id FROM clubs WHERE id = %d",
        $club_id
    ),
    ARRAY_A
);
```

2. In the foreach loop, skip if existing value is non-empty:
```php
foreach ($provider_ids as $db_column => $value) {
    // Skip if column already has a value (never overwrite)
    if (isset($existing[$db_column]) && trim($existing[$db_column]) !== '') {
        continue;
    }
    // ... rest of loop
}
```

This fulfills UPDATE-04: Never overwrite existing data without confirmation.

Return count of ACTUALLY updated columns (not skipped ones).
  </action>
  <verify>grep -n "never overwrite" class-ffm-auto-applier.php shows comment or check existing values</verify>
  <done>Auto-applier skips provider IDs that already have values in database</done>
</task>

<task type="auto">
  <name>Task 3: Add apply_approved_items() to process approved review queue items</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php</files>
  <action>
Add method to apply all approved items from review queue to database:

```php
/**
 * Apply all approved review queue items to clubs table.
 *
 * For each approved item:
 * - Extract provider IDs from csv_row_data JSON
 * - Update clubs table with provider IDs
 * - Update club_id_map_tasks status to 'done'
 * - Insert name variations into club_aliases
 *
 * @return array Stats: applied, skipped, errors.
 */
public function apply_approved_items() {
    $stats = [
        'applied' => 0,
        'skipped' => 0,
        'errors' => 0,
    ];

    // Get all approved items that haven't been processed yet
    $items = $this->db->get_results(
        "SELECT id, approved_club_id, csv_row_data
         FROM `" . self::TABLE_NAME . "`
         WHERE review_status = 'approved'
         AND approved_club_id IS NOT NULL",
        ARRAY_A
    );

    if (empty($items)) {
        return $stats;
    }

    $csv_parser = new FFM_CSV_Parser();
    $auto_applier = new FFM_Auto_Applier($this->db);

    foreach ($items as $item) {
        $club_id = (int) $item['approved_club_id'];
        $csv_row = json_decode($item['csv_row_data'], true);

        if (!$csv_row || $club_id <= 0) {
            $stats['errors']++;
            continue;
        }

        // Build a fake match result for apply_match
        $match_result = [
            'status' => 'exact_match',
            'confidence' => 'high',
            'club_id' => $club_id,
        ];

        $result = $auto_applier->apply_match($match_result, $csv_row, $csv_parser);

        if ($result['applied']) {
            $stats['applied']++;
        } else {
            $stats['skipped']++;
        }
    }

    return $stats;
}
```

This enables approved review items to be applied to the database.
  </action>
  <verify>grep -n "apply_approved_items" class-ffm-uncertain-queue.php shows method</verify>
  <done>FFM_Uncertain_Queue has apply_approved_items() method</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Auto-applier updates club_id_map_tasks to 'done' after applying provider IDs
- [ ] Auto-applier skips columns that already have values
- [ ] FFM_Uncertain_Queue has apply_approved_items() method
- [ ] No PHP errors on page load
</verification>

<success_criteria>

- All tasks completed
- Task status updates work correctly
- Overwrite protection prevents data loss
- Approved review items can be applied
</success_criteria>

<output>
After completion, create `.planning/phases/08-import-execution/08-02-SUMMARY.md`
</output>
