---
phase: 08-import-execution
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php
autonomous: false
---

<objective>
Add "Apply Approved" button to Review Queue UI and ensure Club ID Mapper reflects import progress.

Purpose: Complete the review workflow by allowing approved items to be applied to database.
Output: Functional "Apply Approved" button that processes approved review items.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-import-execution/08-02-SUMMARY.md

# Source files
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Apply Approved" button and handler to Review Queue tab</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php</files>
  <action>
1. Add handler in admin_init hook for `ffm_apply_approved`:
   - After the batch review handler block, add:
   ```php
   // Handle apply approved items
   if (isset($_POST['ffm_apply_approved'])) {
       if (empty($_POST['ffm_apply_approved_nonce']) || !wp_verify_nonce($_POST['ffm_apply_approved_nonce'], 'ffm_apply_approved')) {
           add_settings_error('ffm', 'nonce_error', 'Security check failed.', 'error');
           return;
       }
       $queue = new FFM_Uncertain_Queue();
       $stats = $queue->apply_approved_items();

       $message = sprintf(
           'Apply complete: %d club(s) updated, %d skipped, %d errors.',
           $stats['applied'],
           $stats['skipped'],
           $stats['errors']
       );
       add_settings_error('ffm', 'apply_result', $message, $stats['errors'] > 0 ? 'warning' : 'success');

       wp_safe_redirect(admin_url('admin.php?page=ffm-club-id-mapper&tab=review'));
       exit;
   }
   ```

2. In ffm_render_review_queue_tab(), add an "Apply Approved" section:
   - After pending count, add:
   ```php
   // Get count of approved items ready to apply
   $approved_count = $queue->get_approved_count(); // Need to add this method

   if ($approved_count > 0) {
       echo '<div style="margin-bottom: 15px; padding: 10px; background: #d4edda; border-left: 3px solid #28a745;">';
       echo '<form method="post" style="display: inline;">';
       wp_nonce_field('ffm_apply_approved', 'ffm_apply_approved_nonce');
       echo '<strong>' . esc_html($approved_count) . ' approved item(s)</strong> ready to apply. ';
       echo '<button type="submit" name="ffm_apply_approved" value="1" class="button button-primary" ';
       echo 'onclick="return confirm(\'Apply ' . esc_attr($approved_count) . ' approved item(s) to the database?\');">';
       echo 'Apply Approved Items</button>';
       echo '</form>';
       echo '</div>';
   }
   ```

3. Add get_approved_count() method to FFM_Uncertain_Queue (in class-ffm-uncertain-queue.php):
   ```php
   /**
    * Get count of approved items ready to apply.
    *
    * @return int Number of approved items.
    */
   public function get_approved_count() {
       $count = $this->db->get_var(
           "SELECT COUNT(*) FROM `" . self::TABLE_NAME . "`
            WHERE review_status = 'approved'
            AND approved_club_id IS NOT NULL"
       );
       return (int) $count;
   }
   ```
  </action>
  <verify>Visit Review Queue tab, see "Apply Approved" section if approved items exist</verify>
  <done>Review Queue shows Apply Approved button when approved items exist</done>
</task>

<task type="auto">
  <name>Task 2: Add import status to Club Mapper tab showing provider coverage</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php</files>
  <action>
Add a "Provider Coverage" summary to ffm_render_import_controls():

After the last import stats, add a query that shows how many clubs have each provider ID populated:

```php
// Provider coverage stats
echo '<h3 style="margin-top: 15px; margin-bottom: 10px;">Provider Coverage</h3>';

$coverage = ffm_get_provider_coverage();
echo '<table class="widefat" style="max-width: 400px;">';
echo '<thead><tr><th>Provider</th><th style="width: 100px;">Clubs</th></tr></thead>';
echo '<tbody>';
foreach ($coverage as $provider => $count) {
    echo '<tr>';
    echo '<td>' . esc_html($provider) . '</td>';
    echo '<td>' . esc_html(number_format($count)) . '</td>';
    echo '</tr>';
}
echo '</tbody>';
echo '</table>';
```

Add ffm_get_provider_coverage() function:

```php
/**
 * Get count of clubs with each provider ID populated.
 *
 * @return array Provider label => count.
 */
function ffm_get_provider_coverage(): array {
    $db = kt_ffdb();

    $columns = [
        'WhoScored (w_id)' => 'w_id',
        'Transfermarkt (t_id)' => 't_id',
        'Sofifa (sf_id)' => 'sf_id',
        'Opta (o_id)' => 'o_id',
        'FotMob (fmob_id)' => 'fmob_id',
        'SportMonks (sm_id)' => 'sm_id',
        'InStat (is_id)' => 'is_id',
        'SkillCorner (sc_id)' => 'sc_id',
        'Football Manager (fmgr_id)' => 'fmgr_id',
    ];

    $coverage = [];
    foreach ($columns as $label => $column) {
        $col_escaped = str_replace('`', '``', $column);
        $count = $db->get_var(
            "SELECT COUNT(*) FROM clubs WHERE `{$col_escaped}` IS NOT NULL AND TRIM(`{$col_escaped}`) <> ''"
        );
        $coverage[$label] = (int) $count;
    }

    return $coverage;
}
```

This fulfills PLUGIN-04: Club ID Mapper UI reflects import progress for all providers.
  </action>
  <verify>Visit Club Mapper tab, see Provider Coverage table with counts</verify>
  <done>Admin UI shows provider coverage statistics</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete import workflow with Apply Approved button and provider coverage display</what-built>
  <how-to-verify>
    1. Go to WordPress admin → Club ID Mapper → Club Mapper tab
    2. Verify "Provider Coverage" table shows counts for each provider
    3. If you haven't run the import yet, click "Run CSV Import" to populate data
    4. Go to Review Queue tab
    5. If there are pending items, approve a few manually (click Approve button)
    6. After approving, verify "Apply Approved Items" button appears with count
    7. Click "Apply Approved Items" button
    8. Verify success message shows how many were applied
    9. Return to Club Mapper tab, verify Provider Coverage counts increased
  </how-to-verify>
  <resume-signal>Type "approved" if the full workflow works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Review Queue shows "Apply Approved" button when approved items exist
- [ ] Clicking Apply Approved processes items and shows results
- [ ] Club Mapper tab shows Provider Coverage table
- [ ] Coverage counts update after import/apply operations
</verification>

<success_criteria>

- All tasks completed
- Full import workflow works end-to-end
- User approved visual/functional verification
</success_criteria>

<output>
After completion, create `.planning/phases/08-import-execution/08-03-SUMMARY.md`
</output>
