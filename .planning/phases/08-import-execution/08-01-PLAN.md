---
phase: 08-import-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-import-runner.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
autonomous: false
---

<objective>
Create the import orchestrator that runs the full CSV import pipeline: parse → match → auto-apply confident → queue uncertain. Add an "Import CSV" button to the admin UI that triggers the import and displays results.

Purpose: Tie together all previous phases into a single import workflow with progress reporting.
Output: FFM_Import_Runner class with run_import() method and admin UI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependencies)
@.planning/phases/05-auto-apply/05-01-SUMMARY.md
@.planning/phases/06-uncertain-match-queue/06-01-SUMMARY.md
@.planning/phases/07-review-ui/07-01-SUMMARY.md

# Source files to understand
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-csv-parser.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-matching-engine.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-auto-applier.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FFM_Import_Runner class with run_import() method</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-import-runner.php</files>
  <action>
Create FFM_Import_Runner class that orchestrates the full import:

1. Constructor accepts optional dependencies: $csv_parser, $matching_engine, $auto_applier, $uncertain_queue. Default to creating new instances.

2. `run_import()` method:
   - Load CSV via FFM_CSV_Parser::load()
   - Run FFM_Matching_Engine::match_all_csv_rows() to get all match results
   - Run FFM_Auto_Applier::apply_all_confident() for confident matches
   - Run FFM_Uncertain_Queue::queue_all_uncertain() for uncertain/no_match
   - Return combined statistics array with:
     - csv_rows: total rows in CSV
     - matching: stats from matching engine (exact_match, alias_match, uncertain, no_match)
     - applied: count from auto-applier (applied, skipped)
     - queued: count from uncertain queue (queued, skipped)
     - errors: any errors encountered
     - duration_seconds: time taken

3. Add `get_import_status()` static method that returns:
   - has_been_run: boolean (check for WP option `ffm_last_import_timestamp`)
   - last_run: datetime string or null
   - last_stats: stored stats from last run or null

4. Store last run results in WP option `ffm_import_results` after each import.

Pattern follows FFM_Auto_Applier constructor DI pattern.
  </action>
  <verify>File exists and contains class FFM_Import_Runner with run_import() method</verify>
  <done>FFM_Import_Runner class created with orchestration logic</done>
</task>

<task type="auto">
  <name>Task 2: Add "Import CSV" button and results display to admin UI</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php</files>
  <action>
Add import controls to the Club Mapper tab in admin-page.php:

1. Add "CSV Import" section below the migration controls card (new card):
   - "Run CSV Import" button (with confirmation dialog)
   - Display last import stats if available (using FFM_Import_Runner::get_import_status())
   - Show timestamp of last run

2. Add POST handler in admin_init hook for `ffm_run_import`:
   - Verify nonce (`ffm_run_import_nonce`)
   - Create FFM_Import_Runner and call run_import()
   - Display results via add_settings_error() with success/info message
   - Format message: "Import complete: X rows processed, Y auto-applied, Z queued for review, W errors"

3. Add ffm_render_import_controls() function (similar pattern to ffm_render_migration_controls()):
   - Card with "CSV Import" heading
   - Form with nonce and submit button
   - Display last run stats if available:
     - Last run timestamp
     - Rows processed, auto-applied, queued, errors
   - If never run: "Import has not been run yet"

4. Call ffm_render_import_controls() in ffm_render_club_id_mapper_page() after ffm_render_migration_controls().

IMPORTANT: The import button should have onclick="return confirm('Run CSV import? This will process all 1,712 clubs from the CSV.');"
  </action>
  <verify>Visit WP admin Club ID Mapper page, see Import CSV section with button</verify>
  <done>Admin UI shows import controls and displays last import stats</done>
</task>

<task type="auto">
  <name>Task 3: Register import runner class in plugin bootstrap</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php</files>
  <action>
Add require_once for the new class file, maintaining alphabetical order with other class includes:

```php
require_once __DIR__ . '/includes/class-ffm-import-runner.php';
```

Place after class-ffm-csv-parser.php and before class-ffm-matching-engine.php (alphabetical).
  </action>
  <verify>No PHP errors on page load</verify>
  <done>Plugin loads FFM_Import_Runner class on bootstrap</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>CSV import button on admin page that orchestrates the full import pipeline</what-built>
  <how-to-verify>
    1. Go to WordPress admin → Club ID Mapper
    2. On the Club Mapper tab, look for "CSV Import" card below "Schema Migrations"
    3. Click "Run CSV Import" button, confirm the dialog
    4. Wait for import to complete (may take a few seconds for 1,712 rows)
    5. Verify success message shows statistics (rows, auto-applied, queued, errors)
    6. Verify "Last import" section shows timestamp and stats
    7. Check Review Queue tab - should now have pending items if any uncertain matches exist
  </how-to-verify>
  <resume-signal>Type "approved" if import runs successfully with stats displayed, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] FFM_Import_Runner class exists with run_import() method
- [ ] Admin UI shows CSV Import section with button
- [ ] Import can be triggered from admin UI
- [ ] Results display after import completes
- [ ] No PHP errors during import
</verification>

<success_criteria>

- All tasks completed
- Import runs without errors
- Statistics displayed correctly
- User approved the visual/functional verification
</success_criteria>

<output>
After completion, create `.planning/phases/08-import-execution/08-01-SUMMARY.md`
</output>
