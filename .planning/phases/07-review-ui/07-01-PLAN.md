---
phase: 07-review-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php
autonomous: true
---

<objective>
Build batch review interface for uncertain CSV matches in WordPress admin.

Purpose: Enable user to review uncertain/no_match results from Phase 6, approve with club selection, reject, or skip.
Output: Working Review Queue tab in Club ID Mapper admin page with approve/reject/skip actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-uncertain-match-queue/06-01-SUMMARY.md

# Key source files:
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add query methods to FFM_Uncertain_Queue</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php</files>
  <action>
Add the following methods to FFM_Uncertain_Queue class:

1. `get_pending_items($limit = 50, $offset = 0)` - Returns array of pending review items:
   - Query csv_import_review_queue WHERE review_status = 'pending'
   - ORDER BY id ASC (oldest first)
   - Include LIMIT/OFFSET for pagination
   - For each item, decode candidate_club_ids JSON and fetch club details (canonical_name, competition_code) from clubs table
   - Return array with queue item data plus resolved candidate club details

2. `get_pending_count()` - Returns count of pending items for pagination.

3. `approve_item($queue_id, $club_id)` - Approve an item with selected club:
   - UPDATE csv_import_review_queue SET review_status = 'approved', approved_club_id = $club_id, reviewed_at = NOW() WHERE id = $queue_id
   - Return true/false

4. `reject_item($queue_id)` - Reject an item (no valid match):
   - UPDATE csv_import_review_queue SET review_status = 'rejected', reviewed_at = NOW() WHERE id = $queue_id
   - Return true/false

5. `skip_item($queue_id)` - Skip for later:
   - UPDATE csv_import_review_queue SET review_status = 'skipped', reviewed_at = NOW() WHERE id = $queue_id
   - Return true/false

Use same $this->db connection pattern as existing methods. Sanitize all inputs via $this->db->prepare().
  </action>
  <verify>PHP syntax check: `php -l class-ffm-uncertain-queue.php` passes</verify>
  <done>All 5 methods added with proper DB queries and sanitization</done>
</task>

<task type="auto">
  <name>Task 2: Add Review Queue tab to admin page</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php</files>
  <action>
Modify ffm_render_club_id_mapper_page() to add a tabbed interface:

1. Add tab navigation at top (after h1, before migration controls):
   ```php
   $current_tab = isset($_GET['tab']) ? sanitize_text_field($_GET['tab']) : 'mapper';
   echo '<nav class="nav-tab-wrapper">';
   echo '<a href="?page=ffm-club-id-mapper&tab=mapper" class="nav-tab ' . ($current_tab === 'mapper' ? 'nav-tab-active' : '') . '">Club Mapper</a>';
   echo '<a href="?page=ffm-club-id-mapper&tab=review" class="nav-tab ' . ($current_tab === 'review' ? 'nav-tab-active' : '') . '">Review Queue</a>';
   echo '</nav>';
   ```

2. Wrap existing content in conditional:
   ```php
   if ($current_tab === 'mapper') {
       // existing mapper UI code
   } elseif ($current_tab === 'review') {
       ffm_render_review_queue_tab();
   }
   ```

3. Create ffm_render_review_queue_tab() function that:
   - Instantiates FFM_Uncertain_Queue
   - Gets pending count and items (paginated, 50 per page)
   - Renders a table with columns: CSV Name, Country, Status, Confidence, Candidates, Actions
   - For each row:
     - Display csv_name, csv_country, match_status, confidence
     - Display candidate clubs as radio buttons (if any candidates exist) or "No candidates found"
     - Approve button (submits selected club_id), Reject button, Skip button
   - Pagination at bottom (same pattern as mapper tab)

4. Handle form submissions in admin_init hook:
   - Check for ffm_review_action POST with nonce ffm_review_action_nonce
   - action = approve: call $queue->approve_item($queue_id, $club_id)
   - action = reject: call $queue->reject_item($queue_id)
   - action = skip: call $queue->skip_item($queue_id)
   - Add settings_error() for success/failure feedback
   - Redirect back to review tab with same pagination

Table styling should match existing widefat striped pattern. Use WordPress nonces for all form actions.
  </action>
  <verify>
    - Page loads without PHP errors: visit WordPress admin > Club ID Mapper
    - Both tabs display correctly
    - Review Queue tab shows pending count
  </verify>
  <done>
    - Tabbed interface with Mapper and Review Queue tabs
    - Review Queue displays pending items with candidate selection
    - Approve/Reject/Skip actions work and update database
  </done>
</task>

<task type="auto">
  <name>Task 3: Add batch actions to Review Queue</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php</files>
  <action>
Enhance ffm_render_review_queue_tab() with batch action support:

1. Add checkbox column to each row (name="review_ids[]" value="{queue_id}")
2. Add "Select All" checkbox in header
3. Add batch action bar above table:
   ```php
   <div style="margin-bottom: 10px;">
     <select name="batch_action" id="ffm-batch-action">
       <option value="">Bulk Actions</option>
       <option value="reject_all">Reject Selected</option>
       <option value="skip_all">Skip Selected</option>
     </select>
     <button type="submit" name="ffm_batch_review" class="button">Apply</button>
   </div>
   ```

4. Handle batch submission in admin_init:
   - If ffm_batch_review POST with valid nonce
   - Get review_ids array and batch_action
   - For each ID: call appropriate method (reject_item or skip_item)
   - Count successes, show summary in settings_error()

5. Add JavaScript for Select All checkbox functionality:
   ```javascript
   document.getElementById('ffm-select-all').addEventListener('change', function() {
     var checkboxes = document.querySelectorAll('input[name="review_ids[]"]');
     checkboxes.forEach(cb => cb.checked = this.checked);
   });
   ```

Note: Batch approve not included because each approval needs a specific club_id selection.
  </action>
  <verify>
    - Select All checkbox toggles all row checkboxes
    - Bulk Reject Selected works for multiple items
    - Bulk Skip Selected works for multiple items
    - Success message shows count of processed items
  </verify>
  <done>
    - Batch selection with Select All checkbox
    - Bulk Reject and Skip actions process multiple items
    - Summary feedback after batch operations
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `php -l class-ffm-uncertain-queue.php` passes (no syntax errors)
- [ ] `php -l admin-page.php` passes (no syntax errors)
- [ ] Club ID Mapper page loads without errors
- [ ] Both tabs (Mapper, Review Queue) render correctly
- [ ] Individual approve/reject/skip actions work
- [ ] Batch reject/skip actions work
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- REVIEW-01 satisfied: Pending items displayed with CSV data and candidates
- REVIEW-02 satisfied: Approve/reject/skip actions work
- REVIEW-03 satisfied: Batch reject/skip for multiple items
</success_criteria>

<output>
After completion, create `.planning/phases/07-review-ui/07-01-SUMMARY.md`
</output>
