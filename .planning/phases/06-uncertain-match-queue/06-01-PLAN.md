---
phase: 06-uncertain-match-queue
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
autonomous: true
---

<objective>
Create FFM_Uncertain_Queue class to store uncertain and no_match results from the matching engine for manual review.

Purpose: When CSV rows don't auto-match (multiple candidates, country mismatch, or no match), queue them for Phase 7's review UI. This separates confident auto-apply (Phase 5) from manual review workflow.

Output:
- FFM_Uncertain_Queue class with queue_match() and queue_all_uncertain() methods
- Review queue table created via migration pattern
- Class registered in plugin bootstrap
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (matching engine output format)
@.planning/phases/04-matching-engine/04-01-SUMMARY.md

# Existing code patterns
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-matching-engine.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-auto-applier.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-migrations.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FFM_Uncertain_Queue class with queue_match() method</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php</files>
  <action>
Create FFM_Uncertain_Queue class following existing patterns (constructor DI for database):

1. Add migration for `csv_import_review_queue` table via FFM_Migrations pattern:
   - id (auto-increment primary key)
   - csv_row_index (int) - original row number in CSV
   - csv_name (varchar 255) - primary name from CSV for display
   - csv_country (varchar 100) - country from CSV
   - csv_row_data (text) - JSON-encoded full CSV row for provider IDs extraction later
   - match_status (varchar 50) - 'uncertain' or 'no_match'
   - confidence (varchar 20) - 'medium', 'low', or 'none'
   - candidate_club_ids (text) - JSON array of candidate club IDs
   - review_status (varchar 20) - 'pending', 'approved', 'rejected', 'skipped' (default 'pending')
   - approved_club_id (int nullable) - club_id chosen during review
   - reviewed_at (datetime nullable)
   - created_at (datetime default CURRENT_TIMESTAMP)
   - INDEX on review_status for filtering

2. Constructor accepts optional $db parameter (defaults to kt_ffdb())

3. queue_match() method:
   - Parameters: $match_result (from FFM_Matching_Engine::match_csv_row), $csv_row (full row array), $csv_parser (for extracting data)
   - Only queues if status is 'uncertain' or 'no_match' (returns false otherwise)
   - Extracts csv_name via $csv_parser->get_primary_name()
   - Extracts csv_country via $csv_parser->get_country()
   - Stores candidate IDs as JSON array from $match_result['candidates']
   - Uses INSERT with prepared statement
   - Returns inserted ID on success, false on failure
  </action>
  <verify>File exists with class definition, migration method, and queue_match() method. PHP syntax check passes: php -l class-ffm-uncertain-queue.php</verify>
  <done>FFM_Uncertain_Queue class with queue_match() method that stores uncertain/no_match results in csv_import_review_queue table</done>
</task>

<task type="auto">
  <name>Task 2: Add queue_all_uncertain() batch method with statistics</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-uncertain-queue.php</files>
  <action>
Add queue_all_uncertain() public method to FFM_Uncertain_Queue:

1. Parameters: $match_results (array from FFM_Matching_Engine::match_all_csv_rows), $csv_parser (for row data extraction)

2. Iterates through $match_results['results'] array

3. For each result:
   - Gets the original CSV row via $csv_parser->get_rows()[$result['row_index']]
   - Calls queue_match() for uncertain/no_match status
   - Tracks queued vs skipped (exact_match/alias_match are skipped)

4. Returns statistics array:
   - 'queued' => count of items added to queue
   - 'skipped' => count of confident matches (not queued)
   - 'errors' => count of failed queue operations
   - 'total' => total processed

5. Add ensure_table_exists() method that runs the migration if table doesn't exist (called at start of queue_all_uncertain)
  </action>
  <verify>queue_all_uncertain() method exists with proper signature and returns stats array. PHP syntax check passes.</verify>
  <done>Batch method that queues all uncertain matches from matching engine output with statistics for reporting</done>
</task>

<task type="auto">
  <name>Task 3: Register class in plugin bootstrap</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php</files>
  <action>
Add require_once for the new class file:

1. Add after existing class includes:
   require_once __DIR__ . '/includes/class-ffm-uncertain-queue.php';

2. Follows same pattern as class-ffm-auto-applier.php and class-ffm-matching-engine.php includes
  </action>
  <verify>Plugin file includes the new class. PHP syntax check passes on plugin file.</verify>
  <done>FFM_Uncertain_Queue class loaded when plugin initializes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] php -l on all modified files passes
- [ ] FFM_Uncertain_Queue class exists with queue_match() and queue_all_uncertain() methods
- [ ] Migration method creates csv_import_review_queue table with required columns
- [ ] Class follows existing patterns (constructor DI, kt_ffdb() default)
- [ ] Plugin bootstrap includes the new class file
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- FFM_Uncertain_Queue ready for Phase 7 (Review UI) and Phase 8 (Import Execution)
- queue_all_uncertain() integrates with FFM_Matching_Engine::match_all_csv_rows() output
</success_criteria>

<output>
After completion, create `.planning/phases/06-uncertain-match-queue/06-01-SUMMARY.md`
</output>
