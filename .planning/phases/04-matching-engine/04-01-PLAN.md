---
phase: 04-matching-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-matching-engine.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
autonomous: true
---

<objective>
Build the matching engine that finds database clubs matching CSV rows using exact name matching with country validation.

Purpose: The matching engine is the core logic that determines which CSV rows can be auto-applied and which need manual review. It connects CSV parser output to database lookups using the name normalizer and country mapper utilities built in prior phases.

Output: `FFM_Matching_Engine` class with methods to match individual CSV rows against database clubs, returning confidence levels (exact_match, alias_match, uncertain, no_match).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior phase outputs (established APIs):
@.planning/phases/02-csv-parser-country-mapping/02-01-SUMMARY.md
@.planning/phases/02-csv-parser-country-mapping/02-02-SUMMARY.md
@.planning/phases/03-name-normalization/03-01-SUMMARY.md

Source files to use:
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-csv-parser.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-country-mapper.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-name-normalizer.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/query-club-queue.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/db-footyforums-data.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FFM_Matching_Engine class with database lookup methods</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-matching-engine.php</files>
  <action>
Create FFM_Matching_Engine class with:

1. Constructor that accepts optional $db parameter (uses kt_ffdb() if not provided)

2. `find_clubs_by_name($name)` - Find clubs matching a name (exact or normalized):
   - Query clubs table: SELECT id, canonical_name, competition_code FROM clubs WHERE canonical_name = %s (case-insensitive via LOWER())
   - Also query using FFM_Name_Normalizer::normalize() comparison
   - Return array of matching club objects

3. `find_clubs_by_alias($name)` - Find clubs via club_aliases table:
   - Query: SELECT DISTINCT club_id FROM club_aliases WHERE alias_name = %s (case-insensitive)
   - For each club_id, fetch full club record from clubs table
   - Return array of club objects with alias info

4. `get_club_competition_code($club_id)` - Get competition code for a club:
   - Query v_club_primary_competition view: SELECT competition_code FROM v_club_primary_competition WHERE club_id = %d
   - Return competition_code string or null

Database pattern: Use kt_ffdb() for connection (established pattern from query-club-queue.php). Use $db->prepare() for all queries with parameters (SQL injection prevention).
  </action>
  <verify>File exists with class containing all 4 methods. No syntax errors: `php -l class-ffm-matching-engine.php`</verify>
  <done>FFM_Matching_Engine class created with database lookup methods for clubs and aliases</done>
</task>

<task type="auto">
  <name>Task 2: Add match_csv_row() method with confidence scoring</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-matching-engine.php, app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php</files>
  <action>
Add match_csv_row() method to FFM_Matching_Engine:

```php
public function match_csv_row($csv_row, $csv_parser) {
    // Returns associative array:
    // [
    //   'status' => 'exact_match' | 'alias_match' | 'uncertain' | 'no_match',
    //   'club_id' => int | null,
    //   'club_name' => string | null,
    //   'confidence' => 'high' | 'medium' | 'low' | 'none',
    //   'match_type' => 'canonical' | 'alias' | 'normalized' | null,
    //   'candidates' => array (for uncertain matches with multiple candidates)
    // ]
}
```

Logic flow:
1. Extract data from CSV row using $csv_parser methods:
   - $primary_name = $csv_parser->get_primary_name($csv_row)
   - $csv_country = $csv_parser->get_country($csv_row)
   - $name_variations = $csv_parser->get_name_variations($csv_row)

2. Try exact canonical name match first:
   - find_clubs_by_name($primary_name)
   - Filter results by country using FFM_Country_Mapper::validate_club_country()
   - If exactly 1 match with valid country → status='exact_match', confidence='high'

3. Try alias matches:
   - For each name in $name_variations, call find_clubs_by_alias($name)
   - Filter by country validation
   - If exactly 1 unique club_id with valid country → status='alias_match', confidence='high'

4. Handle multiple candidates:
   - If 2+ clubs pass country validation → status='uncertain', include all as candidates
   - If 0 clubs pass country validation but some existed → status='uncertain' (country mismatch)

5. No match:
   - If no clubs found at all → status='no_match', confidence='none'

Register class in main plugin file:
- Add require_once for class-ffm-matching-engine.php
  </action>
  <verify>
1. Syntax check: `php -l class-ffm-matching-engine.php`
2. Class loads without errors when plugin file is included
  </verify>
  <done>match_csv_row() method returns structured result with status, club_id, confidence, and candidates for all match scenarios</done>
</task>

<task type="auto">
  <name>Task 3: Add match_all_csv_rows() batch method with statistics</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-matching-engine.php</files>
  <action>
Add batch matching method to FFM_Matching_Engine:

```php
public function match_all_csv_rows($csv_parser) {
    // Returns:
    // [
    //   'results' => [
    //     ['row_index' => 0, 'csv_name' => 'Arsenal', ...match result...],
    //     ['row_index' => 1, 'csv_name' => 'Barcelona', ...match result...],
    //   ],
    //   'stats' => [
    //     'total' => 1712,
    //     'exact_match' => 450,
    //     'alias_match' => 200,
    //     'uncertain' => 100,
    //     'no_match' => 962,
    //   ]
    // ]
}
```

Implementation:
1. Ensure CSV is loaded: if (!$csv_parser->is_loaded()) return error
2. Iterate all rows via $csv_parser->get_rows()
3. For each row, call match_csv_row() and collect result
4. Track statistics by status type
5. Include row_index and csv_name in each result for traceability

This method will be used by:
- Phase 5 (Auto-Apply) to get all exact/alias matches
- Phase 6 (Uncertain Queue) to get uncertain matches
- Phase 8 (Import Execution) for full import stats
  </action>
  <verify>
1. Syntax check passes
2. Method signature matches specification
  </verify>
  <done>match_all_csv_rows() returns complete batch results with per-row match data and aggregate statistics</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] class-ffm-matching-engine.php exists and passes `php -l` syntax check
- [ ] Class is registered in footyforums-club-id-mapper.php
- [ ] All 6 public methods exist: find_clubs_by_name, find_clubs_by_alias, get_club_competition_code, match_csv_row, match_all_csv_rows
- [ ] No hardcoded credentials or SQL injection vulnerabilities (all queries use prepare())
</verification>

<success_criteria>
- All tasks completed
- FFM_Matching_Engine class provides complete matching API
- Match results include status, confidence, and candidate information
- Batch method provides statistics for downstream phases
- Requirements MATCH-01, MATCH-02, MATCH-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-matching-engine/04-01-SUMMARY.md`
</output>
