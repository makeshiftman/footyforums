---
phase: 05-auto-apply
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-auto-applier.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
autonomous: true
---

<objective>
Implement auto-apply logic for confident club matches.

Purpose: When matching engine returns exact_match or alias_match with high confidence, automatically update the clubs table with provider IDs and insert name variations into club_aliases.
Output: FFM_Auto_Applier class with methods to apply single matches and batch apply all confident matches.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-matching-engine/04-01-SUMMARY.md

# Source files for reference
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-matching-engine.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-csv-parser.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/db-footyforums-data.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FFM_Auto_Applier class with single-match apply method</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-auto-applier.php</files>
  <action>
Create FFM_Auto_Applier class with:

1. Constructor accepting optional $db parameter (defaults to kt_ffdb())

2. `apply_match($match_result, $csv_row, $csv_parser)` method:
   - Validate match_result has status 'exact_match' or 'alias_match' with confidence 'high'
   - If not confident, return ['applied' => false, 'reason' => 'Not a confident match']
   - Extract club_id from match_result
   - Call update_provider_ids($club_id, $csv_row, $csv_parser)
   - Call insert_aliases($club_id, $csv_row, $csv_parser)
   - Return ['applied' => true, 'club_id' => $club_id, 'provider_ids_updated' => $count, 'aliases_inserted' => $count]

3. `update_provider_ids($club_id, $csv_row, $csv_parser)` private method:
   - Get provider IDs using $csv_parser->get_provider_ids($csv_row)
   - Build UPDATE query for clubs table
   - Set id_source to 'csv_import' (provenance tracking per PROJECT.md)
   - Only update columns that have values (skip empty)
   - Use prepared statements
   - Return count of provider IDs updated

4. `insert_aliases($club_id, $csv_row, $csv_parser)` private method:
   - Get name variations using $csv_parser->get_name_variations($csv_row)
   - For each name variation, INSERT IGNORE into club_aliases (avoid duplicates)
   - Columns: club_id, provider='csv_import', alias_name
   - Return count of aliases inserted

Pattern: Follow existing class patterns in codebase - instance class with constructor DI for database connection.
  </action>
  <verify>File exists with correct class structure, syntax check: php -l class-ffm-auto-applier.php</verify>
  <done>FFM_Auto_Applier class with apply_match(), update_provider_ids(), insert_aliases() methods</done>
</task>

<task type="auto">
  <name>Task 2: Add batch apply method for all confident matches</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-auto-applier.php</files>
  <action>
Add `apply_all_confident($match_results, $csv_parser)` method to FFM_Auto_Applier:

1. Accept $match_results array (output from FFM_Matching_Engine::match_all_csv_rows())
2. Initialize counters: applied=0, skipped=0, errors=[]

3. Loop through $match_results['results']:
   - Get original CSV row using row_index from result
   - Call apply_match() for each result
   - Track counts: applied for successful, skipped for non-confident
   - Catch any exceptions, log to errors array with row_index

4. Return summary:
   [
     'applied' => $applied_count,
     'skipped' => $skipped_count,
     'errors' => $errors_array,
     'total' => count($match_results['results'])
   ]

This method enables batch processing while still using the single-match method for consistency.
  </action>
  <verify>Method exists in class, syntax check passes</verify>
  <done>apply_all_confident() batch method returns statistics for downstream reporting</done>
</task>

<task type="auto">
  <name>Task 3: Register auto-applier class in plugin bootstrap</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php</files>
  <action>
Add require_once for the new class file in the plugin's main file:

```php
require_once __DIR__ . '/includes/class-ffm-auto-applier.php';
```

Place it after the existing require_once statements for class-ffm-matching-engine.php, maintaining alphabetical or logical order of includes.
  </action>
  <verify>Plugin loads without errors: Check WP admin loads successfully</verify>
  <done>FFM_Auto_Applier class available when plugin is active</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] FFM_Auto_Applier class exists with apply_match() and apply_all_confident() methods
- [ ] PHP syntax check passes on all modified files
- [ ] Plugin loads without fatal errors (check WP admin or wp-cli)
- [ ] Class follows existing patterns (constructor DI, kt_ffdb() default)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- FFM_Auto_Applier ready for Phase 8 (Import Execution) to use
</success_criteria>

<output>
After completion, create `.planning/phases/05-auto-apply/05-01-SUMMARY.md`
</output>
