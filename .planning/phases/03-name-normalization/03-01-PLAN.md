---
phase: 03-name-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-name-normalizer.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
autonomous: true
---

<objective>
Build Unicode-safe name normalization utility for football club name matching.

Purpose: Enable accurate name matching between CSV import data and database clubs by normalizing names to ASCII-compatible format while preserving matching semantics.
Output: FFM_Name_Normalizer class with normalize() and match() methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work context
@.planning/phases/02-csv-parser-country-mapping/02-01-SUMMARY.md
@.planning/phases/02-csv-parser-country-mapping/02-02-SUMMARY.md

# Relevant source files
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-csv-parser.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-country-mapper.php
</context>

<discovery_notes>
**Discovery Level 1 - Quick Verification completed:**

Environment constraints:
- PHP intl extension NOT available (transliterator_transliterate unavailable)
- iconv IS available with TRANSLIT support
- Database uses utf8mb4 charset

Unicode variations found in data:
- German umlauts: ü, ö, ä (München, Göteborg, Mönchengladbach)
- Scandinavian: ø, å, æ (København, Malmö, Vålerenga)
- Spanish/Portuguese: é, á, ó, ñ, ã (Atlético, Alavés)
- Turkish: ş, ğ, ı (Kasımpaşa)
- German sharp s: ß (Rot-Weiß)

Tested approach:
```php
function normalize_name($name) {
    $result = mb_strtolower($name, "UTF-8");
    $result = iconv("UTF-8", "ASCII//TRANSLIT//IGNORE", $result);
    $result = preg_replace("/[^a-z0-9\\s\\-\\.]/", "", $result);
    $result = preg_replace("/\\s+/", " ", $result);
    return trim($result);
}
```
Result: 12/12 test cases passed including all major Unicode variations.
</discovery_notes>

<tasks>

<task type="auto">
  <name>Task 1: Create FFM_Name_Normalizer class</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-name-normalizer.php</files>
  <action>
Create a static utility class with the following methods:

1. `normalize($name)` - Main normalization function:
   - Input validation (return empty string for null/non-string)
   - mb_strtolower for Unicode-safe lowercase
   - iconv UTF-8 to ASCII//TRANSLIT//IGNORE for accent removal
   - preg_replace to strip remaining non-alphanumeric (keep spaces, hyphens, periods)
   - Collapse multiple spaces, trim result

2. `match($name1, $name2)` - Compare two names after normalization:
   - Normalize both inputs
   - Return boolean for exact match
   - Handle empty inputs (return false)

3. `normalize_for_search($name)` - Aggressive normalization for fuzzy matching:
   - Call normalize() first
   - Additionally strip: "fc", "afc", "cf", "sc", "fk", "if", common suffixes
   - Remove all punctuation and hyphens
   - Return condensed form for broader matching

Follow existing conventions from FFM_Country_Mapper:
- Static class with no state
- Security check at file start: `defined('ABSPATH') || exit;`
- PHPDoc for all public methods
- Type hints in docblocks
  </action>
  <verify>
PHP syntax check: `php -l app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-name-normalizer.php`
  </verify>
  <done>
- FFM_Name_Normalizer class exists with normalize(), match(), normalize_for_search() methods
- File passes PHP syntax check
- Follows WordPress/plugin coding conventions
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate normalizer and verify with real data</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php</files>
  <action>
1. Add require_once for class-ffm-name-normalizer.php in the main plugin file (after existing includes)

2. Run verification test with actual CSV and database data:
   - Load CSV parser and get name variations for a German club (e.g., Bayern München)
   - Get club from database with Unicode name
   - Verify normalize() produces matching output for both
   - Test match() returns true for equivalent names

Test cases to verify inline (using PHP -r or WP-CLI):
- "FC Bayern München" normalizes to "fc bayern munchen"
- "Bayern Munich" normalizes to "bayern munich"
- "Atlético Madrid" normalizes to "atletico madrid"
- "F.C. København" normalizes to "f.c. kobenhavn"
- match("FC Bayern München", "fc bayern münchen") returns true
- normalize_for_search("AFC Bournemouth") strips "afc" prefix
  </action>
  <verify>
Run verification script:
```bash
php -r '
require "app/public/wp-load.php";
echo FFM_Name_Normalizer::normalize("FC Bayern München") . PHP_EOL;
echo FFM_Name_Normalizer::normalize("Atlético Madrid") . PHP_EOL;
echo (FFM_Name_Normalizer::match("München", "munchen") ? "match" : "no match") . PHP_EOL;
'
```
  </verify>
  <done>
- Plugin loads normalizer class without errors
- normalize() correctly handles all Unicode test cases
- match() correctly compares normalized names
- Ready for use by Phase 4 matching engine
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] class-ffm-name-normalizer.php exists and passes `php -l` syntax check
- [ ] Plugin file includes the new class
- [ ] Manual verification: normalize("FC Bayern München") returns "fc bayern munchen"
- [ ] Manual verification: normalize("Kasımpaşa") returns "kasimpasa"
- [ ] Manual verification: match("Atlético Madrid", "Atletico Madrid") returns true
</verification>

<success_criteria>

- FFM_Name_Normalizer class created with normalize(), match(), normalize_for_search()
- All verification checks pass
- No PHP errors when loading plugin
- Requirement MATCH-03 satisfied: "Normalize names for comparison (strip accents, handle common variations)"
</success_criteria>

<output>
After completion, create `.planning/phases/03-name-normalization/03-01-SUMMARY.md`
</output>
