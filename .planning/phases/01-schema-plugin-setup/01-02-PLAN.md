---
phase: 01-schema-plugin-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/query-club-queue.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
autonomous: false
---

<objective>
Add migration controls to the Club ID Mapper admin page and update plugin configuration for new providers.

Purpose: Enable running migrations from the admin UI with visible verification, and configure the plugin to recognize the 5 new provider columns.

Output:
- Migration controls section in Club ID Mapper admin page
- Schema verification display showing which columns/tables exist
- Updated provider configuration for new columns
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-schema-plugin-setup/01-CONTEXT.md

# Prior plan context
@.planning/phases/01-schema-plugin-setup/01-01-SUMMARY.md

# Existing plugin files to modify
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/query-club-queue.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migration controls and verification to admin page</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php, app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php</files>
  <action>
**In footyforums-club-id-mapper.php:**
Add require_once for the new migration runner class:
```php
require_once __DIR__ . '/includes/class-ffm-migration-runner.php';
```

**In admin-page.php:**

1. Add form handler for migration actions in the existing `admin_init` hook:
   - Handle POST 'ffm_run_migrations' (nonce: ffm_run_migrations)
   - Handle POST 'ffm_rollback_migration' with migration_id parameter
   - On success/failure, add admin notice via settings_errors()

2. Add a new section at the TOP of `ffm_render_club_id_mapper_page()` (before the existing filter form) that displays:

**Migration Controls Box** (WordPress admin card style):
```
<div class="card" style="max-width: 800px; margin-bottom: 20px;">
  <h2>Schema Migrations</h2>

  [Migration Status Display]
  - Pending: X migrations
  - Completed: Y migrations

  [If pending migrations exist:]
  <form method="post">
    [nonce field]
    <button type="submit" name="ffm_run_migrations" class="button button-primary">
      Run Pending Migrations
    </button>
  </form>

  [Schema Verification Section]
  <h3>Current Schema Status</h3>
  <table class="widefat">
    <tr><td>clubs.fmob_id</td><td>[EXISTS/MISSING]</td></tr>
    <tr><td>clubs.sm_id</td><td>[EXISTS/MISSING]</td></tr>
    <tr><td>clubs.is_id</td><td>[EXISTS/MISSING]</td></tr>
    <tr><td>clubs.sc_id</td><td>[EXISTS/MISSING]</td></tr>
    <tr><td>clubs.fmgr_id</td><td>[EXISTS/MISSING]</td></tr>
    <tr><td>clubs.id_source</td><td>[EXISTS/MISSING]</td></tr>
    <tr><td>club_aliases table</td><td>[EXISTS/MISSING]</td></tr>
  </table>
</div>
```

3. Schema verification helper function `ffm_get_schema_status()`:
   - Check each expected column exists in clubs table using SHOW COLUMNS
   - Check club_aliases table exists using SHOW TABLES
   - Return array of column_name => exists (boolean)

4. Style the verification display:
   - Green checkmark (✓) for EXISTS
   - Red X for MISSING
   - Use WordPress admin color classes

**Important:** Do NOT modify the existing mapping table or club editing functionality — only add the new migration section above it.
  </action>
  <verify>Admin page loads without PHP errors, migration section displays at top</verify>
  <done>Migration controls and schema verification display added to admin page</done>
</task>

<task type="auto">
  <name>Task 2: Update provider configuration for new columns</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/query-club-queue.php, app/public/wp-content/plugins/footyforums-club-id-mapper/includes/admin-page.php</files>
  <action>
**In query-club-queue.php:**

Update `ffm_get_clubs_column_map()` to add the 5 new providers:
```php
function ffm_get_clubs_column_map(): array {
    return [
        // Existing mappings (keep as-is)
        'transfermarkt' => 't_id',
        'fbref'         => 'f_id',
        'sofascore'     => 's_id',
        'sofifa'        => 'sf_id',
        'whoscored'     => 'w_id',
        'wikipedia'     => 'wp_id',
        'wikidata'      => 'wd_id',
        'statsbomb'     => 'sb_id',
        'understat'     => 'us_id',
        'opta'          => 'o_id',
        // New providers from CSV import
        'fotmob'        => 'fmob_id',
        'sportmonks'    => 'sm_id',
        'instat'        => 'is_id',
        'skillcorner'   => 'sc_id',
        'footballmanager' => 'fmgr_id',
    ];
}
```

**In admin-page.php:**

Update the `$sources_non_opta` array at the top of the file to add the 5 new providers:
```php
$sources_non_opta = [
    // Existing providers (keep as-is)
    'transfermarkt' => 'Transfermarkt',
    'fbref'         => 'FBref',
    'sofascore'     => 'SofaScore',
    'statsbomb'     => 'StatsBomb',
    'understat'     => 'Understat',
    'wikipedia'     => 'Wikipedia',
    'wikidata'      => 'Wikidata',
    'whoscored'     => 'WhoScored',
    'sofifa'        => 'Sofifa',
    'opta'          => 'Opta',
    // New providers from CSV import
    'fotmob'        => 'FotMob',
    'sportmonks'    => 'SportMonks',
    'instat'        => 'InStat',
    'skillcorner'   => 'SkillCorner',
    'footballmanager' => 'Football Manager',
];
```

**Note:** The new columns won't show in the UI until migrations are run, but the configuration should be ready. The existing code already handles missing columns gracefully (they just won't have data).
  </action>
  <verify>No PHP syntax errors in modified files</verify>
  <done>Provider configuration updated with 5 new providers in both column map and source codes list</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Migration controls section added to Club ID Mapper admin page with:
- Migration status display (pending/completed count)
- "Run Pending Migrations" button
- Schema verification table showing status of each column/table
- Updated provider configuration for 5 new sources
  </what-built>
  <how-to-verify>
1. Open WordPress admin in browser
2. Navigate to: Club ID Mapper (in sidebar menu)
3. Verify the page loads without errors
4. At the top of the page, confirm you see:
   - "Schema Migrations" card/section
   - Migration status showing "Pending: 1 migrations"
   - "Run Pending Migrations" button
   - Schema verification table showing all columns as MISSING (expected - migrations not run yet)
5. (Optional) Click "Run Pending Migrations" button
6. Verify the schema status updates to show all columns as EXISTS (green checkmarks)
7. Verify the mapping table below still works (existing functionality preserved)
  </how-to-verify>
  <resume-signal>Type "approved" if the admin UI looks correct and migrations run successfully, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Admin page loads without PHP errors
- [ ] Migration section appears at top of page
- [ ] Schema verification shows column status
- [ ] "Run Pending Migrations" button works
- [ ] After running migrations, verification shows all green checkmarks
- [ ] Existing club mapping functionality still works
- [ ] Provider configuration includes all 5 new providers
</verification>

<success_criteria>

- Migration controls integrated into admin page
- Schema verification display works correctly
- Migrations can be run from admin UI
- Provider configuration updated for new columns
- Existing functionality preserved
- User approved visual verification
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-plugin-setup/01-02-SUMMARY.md`
</output>
