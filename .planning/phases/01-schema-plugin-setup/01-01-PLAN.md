---
phase: 01-schema-plugin-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-migration-runner.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/migrations/001-add-provider-columns.php
autonomous: true
---

<objective>
Create migration infrastructure for the Club ID Mapper plugin with reversible schema changes.

Purpose: Enable safe, reversible database schema updates that can be triggered from the admin UI. This is the foundation for all schema work in this milestone.

Output:
- Migration runner class with up/down support
- First migration file adding 5 new provider ID columns, provenance column, and club_aliases table
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-schema-plugin-setup/01-CONTEXT.md

# Codebase context
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md

# Existing plugin structure
@app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
@app/public/wp-content/plugins/footyforums-club-id-mapper/includes/db-footyforums-data.php

# Current clubs table schema (for reference)
# Existing columns: id, canonical_name, w_id, t_id, sf_id, s_id, f_id, e_team_id, etc.
# See: app/sql/schema/footyforums_data_schema_live.sql lines 71-107
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration runner class</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-migration-runner.php</files>
  <action>
Create a migration runner class that:

1. **Tracks migration state** via `ffm_migrations_run` option (array of completed migration IDs)

2. **Discovers migrations** by scanning `includes/migrations/` directory for files matching `NNN-*.php`

3. **Runs pending migrations** via `run_pending()`:
   - Get list of completed migrations from option
   - Scan migrations directory for all migration files
   - For each migration not in completed list, require file and call `up()` method
   - On success, add to completed list and save option
   - Return array of results (migration_id => success/error message)

4. **Supports rollback** via `rollback($migration_id)`:
   - Require the migration file
   - Call `down()` method
   - Remove from completed list and save option
   - Return success/error message

5. **Reports status** via `get_status()`:
   - Return array with: completed migrations, pending migrations, total count

Migration file interface expected:
```php
// Each migration file returns an array with 'up' and 'down' callables
return [
    'id' => '001-add-provider-columns',
    'up' => function($db) { /* ALTER TABLE statements */ return true; },
    'down' => function($db) { /* Reverse changes */ return true; }
];
```

Use `kt_ffdb()` from db-footyforums-data.php for database connection.

Follow WordPress coding standards:
- Class name: `FFM_Migration_Runner`
- File security: `defined('ABSPATH') || exit;`
- Use `get_option()` and `update_option()` for state storage
  </action>
  <verify>File exists at correct path with class definition, no PHP syntax errors</verify>
  <done>FFM_Migration_Runner class created with run_pending(), rollback(), get_status() methods</done>
</task>

<task type="auto">
  <name>Task 2: Create schema migration for provider columns and club_aliases table</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/migrations/001-add-provider-columns.php</files>
  <action>
Create migration file that implements the following schema changes:

**UP migration:**

1. Add 5 new provider ID columns to `clubs` table:
   - `fmob_id` VARCHAR(50) DEFAULT NULL — FotMob
   - `sm_id` VARCHAR(50) DEFAULT NULL — SportMonks
   - `is_id` VARCHAR(50) DEFAULT NULL — InStat
   - `sc_id` VARCHAR(50) DEFAULT NULL — SkillCorner
   - `fmgr_id` VARCHAR(50) DEFAULT NULL — Football Manager

2. Add provenance column to `clubs` table:
   - `id_source` VARCHAR(50) DEFAULT NULL — tracks which source provided mappings (e.g., 'csv_import', 'manual')

3. Create `club_aliases` table:
   ```sql
   CREATE TABLE club_aliases (
       id INT NOT NULL AUTO_INCREMENT,
       club_id INT NOT NULL,
       provider VARCHAR(50) NOT NULL,
       alias_name VARCHAR(255) NOT NULL,
       date_added DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
       PRIMARY KEY (id),
       KEY idx_club_provider (club_id, provider),
       KEY idx_alias_lookup (alias_name, provider),
       CONSTRAINT fk_club_aliases_club FOREIGN KEY (club_id) REFERENCES clubs(id) ON DELETE CASCADE
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
   ```

**DOWN migration:**

1. Drop the `club_aliases` table
2. Drop columns: `fmob_id`, `sm_id`, `is_id`, `sc_id`, `fmgr_id`, `id_source`

**Implementation notes:**
- Use ALTER TABLE ... ADD COLUMN IF NOT EXISTS pattern (check if column exists first)
- Wrap all operations in transaction where possible
- Log each operation for debugging
- Return descriptive error messages on failure
- Match existing column style from clubs table (VARCHAR(50), utf8mb4_unicode_ci)
  </action>
  <verify>File exists with valid PHP returning array with 'id', 'up', 'down' keys</verify>
  <done>Migration 001 created with up() adding columns/table and down() removing them</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `class-ffm-migration-runner.php` exists and has no PHP syntax errors
- [ ] `migrations/001-add-provider-columns.php` exists and has no PHP syntax errors
- [ ] Migration file returns array with required keys (id, up, down)
- [ ] Both files follow WordPress coding standards (security check, proper naming)
</verification>

<success_criteria>

- Migration runner class created with full up/down support
- First migration file created with all schema changes
- No PHP syntax errors in new files
- Code follows existing plugin conventions
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-plugin-setup/01-01-SUMMARY.md`
</output>
