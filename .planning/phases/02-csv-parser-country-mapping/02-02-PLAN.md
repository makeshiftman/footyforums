---
phase: 02-csv-parser-country-mapping
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-country-mapper.php
  - app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php
autonomous: true
---

<objective>
Create a country-to-league-prefix mapping utility for validating CSV country fields against database league prefixes.

Purpose: Enable country validation during the matching process. A CSV club from "England" should only match database clubs with league prefixes starting with "eng".

Output:
- FFM_Country_Mapper class with country-to-prefix mapping
- Validation method to check if country maps to known prefix
- Lookup method to get prefix(es) for a country
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md

# Country mapping requirements from PROJECT.md:
# England → eng, Spain → esp, Italy → ita, France → fra
# Germany → ger, Portugal → por, Netherlands → ned, Scotland → sco
# Argentina → arg, Brazil → bra, etc.

# Database context:
# - Clubs have competition_code field with prefixes like "eng.1", "esp.1", "ger.1"
# - Matching requires CSV country to align with club's competition_code prefix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create country-to-league-prefix mapper class</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-country-mapper.php</files>
  <action>
Create FFM_Country_Mapper class with comprehensive country mappings:

1. **Define mapping as class constant** covering all countries likely in CSV:
   ```php
   const COUNTRY_TO_PREFIX = [
       // Major European leagues
       'England'       => 'eng',
       'Spain'         => 'esp',
       'Italy'         => 'ita',
       'France'        => 'fra',
       'Germany'       => 'ger',
       'Portugal'      => 'por',
       'Netherlands'   => 'ned',
       'Scotland'      => 'sco',
       'Belgium'       => 'bel',
       'Turkey'        => 'tur',
       'Greece'        => 'gre',
       'Austria'       => 'aut',
       'Switzerland'   => 'sui',
       'Russia'        => 'rus',
       'Ukraine'       => 'ukr',
       'Poland'        => 'pol',
       'Czech Republic' => 'cze',
       'Denmark'       => 'den',
       'Sweden'        => 'swe',
       'Norway'        => 'nor',

       // South America
       'Argentina'     => 'arg',
       'Brazil'        => 'bra',
       'Chile'         => 'chi',
       'Colombia'      => 'col',
       'Uruguay'       => 'uru',
       'Paraguay'      => 'par',
       'Peru'          => 'per',
       'Ecuador'       => 'ecu',
       'Venezuela'     => 'ven',
       'Bolivia'       => 'bol',

       // North/Central America
       'Mexico'        => 'mex',
       'USA'           => 'usa',
       'United States' => 'usa',

       // Asia
       'Japan'         => 'jpn',
       'South Korea'   => 'kor',
       'China'         => 'chn',
       'Saudi Arabia'  => 'sau',
       'Australia'     => 'aus',

       // Africa
       'Egypt'         => 'egy',
       'South Africa'  => 'rsa',
       'Morocco'       => 'mar',
       'Nigeria'       => 'nga',

       // Other European
       'Croatia'       => 'cro',
       'Serbia'        => 'srb',
       'Romania'       => 'rom',
       'Hungary'       => 'hun',
       'Bulgaria'      => 'bul',
       'Cyprus'        => 'cyp',
       'Israel'        => 'isr',
       'Republic of Ireland' => 'irl',
       'Ireland'       => 'irl',
       'Northern Ireland' => 'nir',
       'Wales'         => 'wal',
       'Finland'       => 'fin',
       'Iceland'       => 'isl',
   ];
   ```

2. **Static get_prefix($country)** method:
   - Input: country string from CSV
   - Output: league prefix string or `null` if not found
   - Case-insensitive matching (normalize to title case for lookup)
   - Trim whitespace

3. **Static is_known_country($country)** method:
   - Input: country string
   - Output: boolean - true if country has a known mapping

4. **Static get_all_mappings()** method:
   - Returns the full COUNTRY_TO_PREFIX array for reference/debugging

Follow WordPress coding standards:
- File security: `defined('ABSPATH') || exit;`
- Class name: `FFM_Country_Mapper`
- Static methods (no instance state needed)
  </action>
  <verify>PHP syntax check passes: `php -l class-ffm-country-mapper.php`</verify>
  <done>FFM_Country_Mapper class created with get_prefix(), is_known_country(), get_all_mappings() methods</done>
</task>

<task type="auto">
  <name>Task 2: Add prefix validation and register class in plugin</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-country-mapper.php, app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php</files>
  <action>
1. **Add validation helper to FFM_Country_Mapper:**

   **Static validate_club_country($csv_country, $club_competition_code)** method:
   - Input: CSV country string, database competition_code (e.g., "eng.1")
   - Output: boolean - true if country matches competition prefix
   - Extract prefix from competition_code (part before first ".")
   - Compare with mapped prefix for CSV country
   - Return false if country is unknown or doesn't match
   - Example: `validate_club_country('England', 'eng.1')` returns `true`
   - Example: `validate_club_country('Germany', 'eng.1')` returns `false`

   ```php
   public static function validate_club_country( $csv_country, $club_competition_code ) {
       $expected_prefix = self::get_prefix( $csv_country );
       if ( null === $expected_prefix ) {
           return false; // Unknown country
       }

       // Extract prefix from competition_code (e.g., "eng.1" -> "eng")
       $parts = explode( '.', $club_competition_code );
       $actual_prefix = $parts[0] ?? '';

       return $expected_prefix === $actual_prefix;
   }
   ```

2. **Add get_unknown_countries($csv_parser) helper** for diagnostics:
   - Input: FFM_CSV_Parser instance (loaded)
   - Output: array of unique country values from CSV that have no mapping
   - Useful for identifying gaps in country mapping

3. **Register class in main plugin file:**
   - Add `require_once __DIR__ . '/includes/class-ffm-country-mapper.php';` to footyforums-club-id-mapper.php
   - Place after the CSV parser require (if both exist) or alongside other includes
  </action>
  <verify>PHP syntax check passes on both modified files</verify>
  <done>Country validation method added, class registered in main plugin file</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `class-ffm-country-mapper.php` exists and has no PHP syntax errors
- [ ] COUNTRY_TO_PREFIX covers major football nations
- [ ] get_prefix() handles case-insensitive lookup
- [ ] validate_club_country() correctly compares prefixes
- [ ] Main plugin file requires the new class
</verification>

<success_criteria>

- Country mapper class created with comprehensive mappings
- Validation method correctly matches CSV country to competition_code prefix
- Case-insensitive country lookup works
- No PHP syntax errors in new or modified files
- Code follows WordPress/plugin conventions
</success_criteria>

<output>
After completion, create `.planning/phases/02-csv-parser-country-mapping/02-02-SUMMARY.md`
</output>
