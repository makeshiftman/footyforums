---
phase: 02-csv-parser-country-mapping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-csv-parser.php
autonomous: true
---

<objective>
Create a CSV parser class that loads and parses the provider mapping CSV file, extracting provider IDs and name variations.

Purpose: Provide structured access to CSV data for the matching engine. This is the foundation for all import operations.

Output:
- FFM_CSV_Parser class with methods to iterate rows
- Provider ID extraction (whoScoredId, transfermarktId, sofifaId, optaId, fotmobId, sportmonksId, inStatId, skillCornerId, fmId)
- Name variation extraction (all *Name columns)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md

# Prior phase context
@.planning/phases/01-schema-plugin-setup/01-01-SUMMARY.md

# Existing plugin structure
@app/public/wp-content/plugins/footyforums-club-id-mapper/footyforums-club-id-mapper.php

# CSV file location and structure
# Path: /Users/kevincasey/Local Sites/footyforums/app/docs/providers/mapping.teamsAlias.csv
# Rows: 1,712 (plus header)
# Key columns for provider IDs: whoScoredId, transfermarktId, sofifaId, optaId, fotmobId, sportmonksId, inStatId, skillCornerId, fmId
# Key columns for names: name, whoScoredName, sofifaName, statsName, optaName, inStatName, transfermarktName, footballDataName, fmName, skillCornerName, fotmobName, sportmonksName
# Key column for country: country
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV parser class with file loading and validation</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-csv-parser.php</files>
  <action>
Create FFM_CSV_Parser class that:

1. **Constructor** accepts optional file path, defaults to the known CSV location:
   ```php
   private $file_path;
   private $rows = [];
   private $headers = [];

   public function __construct($file_path = null) {
       $this->file_path = $file_path ?? $this->get_default_csv_path();
   }
   ```

2. **get_default_csv_path()** returns the path relative to ABSPATH:
   - Path: `ABSPATH . '../docs/providers/mapping.teamsAlias.csv'`
   - (The CSV is in app/docs/ which is one level above app/public/)

3. **load()** method parses the CSV:
   - Open file with `fopen()`, check for failure
   - Read header row with `fgetcsv()`, store in `$this->headers`
   - Read all data rows, store as associative arrays keyed by header names
   - Close file handle
   - Return `true` on success, `false` on failure
   - Log errors via `error_log()`

4. **is_loaded()** returns whether data has been loaded

5. **get_row_count()** returns count of data rows (excluding header)

6. **get_rows()** returns all rows as array of associative arrays

7. **get_row($index)** returns single row by index (0-based)

8. **validate_structure()** checks required columns exist:
   - Required: name, country, whoScoredId, transfermarktId, sofifaId, optaId
   - Returns array of missing columns (empty = valid)

Follow WordPress coding standards:
- File security: `defined('ABSPATH') || exit;`
- Class name: `FFM_CSV_Parser`
- 4-space indentation
  </action>
  <verify>PHP syntax check passes: `php -l class-ffm-csv-parser.php`</verify>
  <done>FFM_CSV_Parser class created with load(), validate_structure(), get_rows(), get_row() methods</done>
</task>

<task type="auto">
  <name>Task 2: Add provider ID and name variation extraction methods</name>
  <files>app/public/wp-content/plugins/footyforums-club-id-mapper/includes/class-ffm-csv-parser.php</files>
  <action>
Add extraction methods to FFM_CSV_Parser:

1. **Define column mappings as class constants:**
   ```php
   // Provider ID columns: CSV column name => database column name
   const PROVIDER_ID_COLUMNS = [
       'whoScoredId'    => 'w_id',
       'transfermarktId' => 't_id',
       'sofifaId'       => 'sf_id',
       'optaId'         => 'o_id',
       'fotmobId'       => 'fmob_id',
       'sportmonksId'   => 'sm_id',
       'inStatId'       => 'is_id',
       'skillCornerId'  => 'sc_id',
       'fmId'           => 'fmgr_id',
   ];

   // Name columns to extract (CSV column names)
   const NAME_COLUMNS = [
       'name',
       'whoScoredName',
       'sofifaName',
       'statsName',
       'optaName',
       'inStatName',
       'transfermarktName',
       'footballDataName',
       'fmName',
       'skillCornerName',
       'fotmobName',
       'sportmonksName',
   ];
   ```

2. **get_provider_ids($row)** extracts provider IDs from a row:
   - Input: associative array (single CSV row)
   - Output: array of `['db_column' => 'value']` for non-empty IDs
   - Skip empty/null values
   - Trim whitespace from values
   - Example output: `['w_id' => '91', 't_id' => '1211', ...]`

3. **get_name_variations($row)** extracts all name variations:
   - Input: associative array (single CSV row)
   - Output: array of unique, non-empty name strings
   - Collect values from all NAME_COLUMNS
   - Trim whitespace
   - Remove duplicates (case-sensitive)
   - Remove empty strings
   - Example output: `['Port Vale', 'Port Vale FC', ...]`

4. **get_country($row)** extracts the country field:
   - Input: associative array (single CSV row)
   - Output: trimmed country string or empty string if not set

5. **get_primary_name($row)** returns the 'name' column value:
   - This is the canonical name from the CSV
   - Returns trimmed string or empty string

Add to main plugin file:
- Add `require_once __DIR__ . '/includes/class-ffm-csv-parser.php';` to footyforums-club-id-mapper.php
  </action>
  <verify>PHP syntax check passes on both modified files</verify>
  <done>Provider ID extraction and name variation extraction methods added, class registered in main plugin file</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `class-ffm-csv-parser.php` exists and has no PHP syntax errors
- [ ] Class can be instantiated without errors
- [ ] PROVIDER_ID_COLUMNS maps all 9 providers correctly
- [ ] NAME_COLUMNS includes all 12 name columns
- [ ] Main plugin file requires the new class
</verification>

<success_criteria>

- CSV parser class created with full data access methods
- Provider ID extraction returns correctly mapped column names
- Name variation extraction collects all unique names per row
- No PHP syntax errors in new or modified files
- Code follows WordPress/plugin conventions (FFM_ prefix, snake_case)
</success_criteria>

<output>
After completion, create `.planning/phases/02-csv-parser-country-mapping/02-01-SUMMARY.md`
</output>
